# Internships for developers

**В данный момент идёт разработка версии v1 приложения**

## Стэк и зависимости.

Для разработки приложения используется Python версии 12 и выше.
В контейнере - **python:3.12.3-bookworm**

Приложение разрабатывается с FastApi, SQLAlchemy ORM, PostgreSQL.

Все зависимости указаны в pyproject.toml.


## Работа с ветками и версиями.


### Окружение

Перед клонированием приложения необходимо локально создать виртуальное окружение.

После клонирования проверить и по необходимости внести в .gitignore название папки окружения.

Убедиться, что в .gitignore внесены .env и certs/.

В корне проекта создать папку .env c переменными окружения по образцу файла .env.template.

В корне проекта создать папку certs и перейти в папку. Выполнить команды **bash**:

                   mkdir certs && cd certs
                   openssl genrsa -out jwt-private.pem 2048
                   openssl rsa -in jwt-private.pem -outform PEM -pubout -out jwt-public.pem

Убедитесь, что ключи - серые - не подсвечены, как и .env.




### Работа с Git и с ветками.

После клонирования приложения в локальную ветку **main**, необходимо создать собственную локальную ветку:

                   development/ваше имя - для разработчиков
                   test/ваше имя - для тестировщиков

Готовый код необходимо обрабатывать с линтерами black, ruff.

После завершение локальной задачи необходимо описывать её в данном README.md.

Изменения необходимо добавлять в git и создавать commit.

Перед push ветки в удалённый репозиторий необходимо убедиться, что все изменения попали в git и выполнить:

                   git switch main
                   git pull origin main
                   git switch development/ваше имя   (возвращаетесь на свою локальную ветку)
                   git merge main
                   git push origin development/ваше имя

Во-избежание гонки веток, необходимо извещать коллег о своих действиях.


### Миграции.

Миграции осуществляются при запущенном контейнере:

                   docker compose exec app alembic revision --autogenerate -m "ваш init"

После проверки файла миграций:

                   docker compose exec app alembic upgrade head


### Тесты

Тестирование запускается в отдельном контейнере с переопределением основной сессии на тестовую.

Команда для запуска тестовой БД:

                   docker compose -f docker-compose.test.yml up -d db_test

Команда для запуска тестов:

                   docker compose -f docker-compose.test.yml run --rm tests

Завершить работу с тестовой БД:

                   docker compose -f docker-compose.test.yml down



## Разработка.
**Сущности доведённые разработчиком до подключенного роута должны быть протестированы с client: AsyncClient.**


### BaseModel(Base)

Абстрактная модель: наследник Base(DeclarativeBase) - sqlalchemy.orm.

Модель содержит общее __repr__ представление для наследников.

Модель присваивает каждой таблице имя по названию модели с прибавлением s.

Например, **class User(BaseModel)** создаёт таблицу **users**.


### Mixins

Представлены два mixins:

                    IntIdPkMixin - добавляет моделям id primary_key.
                    ActiveMixin - добавляет мягкое удаление - архивацию моделей.


### User(IntIdPkMixin, ActiveMixin, BaseModel)


#### Реализовано создание пользователя.

Обработаны исключения уникальности username и password, несовпадение второго с первым паролей.


#### Реализована авторизация пользователя через OAuth2PasswordBearer

При вводе логина и пароля создаётся токен. Время жизни токена установлено на 15 минут.

Обработаны исключения username, password, is_active.


#### Реализован доступ к сведениям о текущем пользователе через токен (авторизованном).

Обработаны исключения валидации.


#### Реализован выпуск refresh-token для пере-выпуска access-token.

Обработаны исключения типов токена.


#### Реализована тестовая рассылка email.

Используем:

**aiosmtplib** — асинхронный SMTP-клиент для отправки писем.

**email.message.EmailMessage** — встроенный класс для создания email-сообщений.

Для тестовой отправки сообщений используем сервис **MailDev**, образ скачиваем через Docker.

Через **Taskiq** реализуем фоновую отправку сообщений,
не влияющую выполнение запросов в основной сессии.

В данный момент реализована только приветственная рассылка при создании пользователя. (http://localhost:8080)

Для тестирования создана мок-фикстура, в связи с тем, что pytest не воспринимает фоновую задачу(Сессию в сессии.)

На продакшн необходима настройка настоящего SMTP-сервера через провайдера (Gmail, Yandex, Mail.ru, Outlook и др.).

#### План по User



Superuser

Настройка ВЕБХУКОВ.

Необходимый CRUD.


### Project

Дальнейшие модели пока не разрабатывались.



## Taskiq и RabbitMQ

Используется Tasking - асинхронная распределённая очередь задач.

Брокер сообщений RabbitMQ.

Для взаимодействия Tasking и RabbitMQ создается экземпляр AioPikaBroker.

Взаимодействие с fastapi через taskiq_fastapi.init.

Асинхронный генератор сессии запускаем через TaskiqDepends.
